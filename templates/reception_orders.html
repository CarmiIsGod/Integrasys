{% extends "base_nav.html" %}

{% block title %}&Oacute;rdenes de servicio{% endblock %}

{% block content %}
<div class="stack-lg">
  <div class="card section">
    <h1 class="mb-3">&Oacute;rdenes de servicio</h1>
    <form class="row g-2 align-items-end" method="get">
      <div class="col-md-4">
        <label class="form-label" for="orders-search">Buscar</label>
        <input class="form-control" type="text" name="q" id="orders-search" placeholder="Folio, cliente, modelo, serie" value="{{ query }}">
      </div>
      <div class="col-md-2">
        <label class="form-label" for="orders-status">Estado</label>
        <select class="form-select" name="status" id="orders-status">
          <option value="">-- Estado --</option>
          {% for code,label in status_choices %}
            <option value="{{ code }}" {% if status == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="orders-assignee">T&eacute;cnico</label>
        <select class="form-select" name="assignee" id="orders-assignee">
          <option value="">-- T&eacute;cnico --</option>
          {% for u in staff_users %}
            <option value="{{ u.id }}" {% if assignee|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>{{ u.get_username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-6 col-md-2">
        <label class="form-label" for="orders-from">Desde</label>
        <input class="form-control" type="date" name="from" id="orders-from" value="{{ dfrom }}" title="Desde (fecha de ingreso)">
      </div>
      <div class="col-sm-6 col-md-2">
        <label class="form-label" for="orders-to">Hasta</label>
        <input class="form-control" type="date" name="to" id="orders-to" value="{{ dto }}" title="Hasta (inclusive)">
      </div>
      <div class="col-12 d-flex flex-wrap gap-2">
        <button class="btn btn-primary" type="submit">Filtrar</button>
        <a class="btn btn-outline-secondary" href="{% url 'list_orders' %}">Limpiar</a>
        <a class="btn btn-outline-info" href="?q={{ query }}&amp;status={{ status }}&amp;assignee={{ assignee }}&amp;from={{ dfrom }}&amp;to={{ dto }}&amp;export=1">Exportar CSV</a>
      </div>
    </form>
  </div>

  <div class="card section">
    <h5 class="mb-3">&Oacute;rdenes</h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Folio</th>
            <th>Cliente</th>
            <th>Equipo</th>
            <th>Estado</th>
            <th>Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for o in page_obj.object_list %}
            <tr>
              <td>{{ o.folio }}</td>
              <td>
                {{ o.device.customer.name }}
                <div class="text-muted small">Tec: {{ o.assigned_to|default:"-" }}</div>
              </td>
              <td>{{ o.device.brand }} {{ o.device.model }} <span class="text-muted">({{ o.device.serial }})</span></td>
              <td>{{ o.get_status_display }}</td>
              <td>{{ o.checkin_at|date:"Y-m-d H:i" }}</td>
              <td class="text-nowrap">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <a class="btn btn-outline-primary btn-sm" href="{% url 'public_status' token=o.token %}" target="_blank" rel="noopener">Ver p&uacute;blico</a>
                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'receipt_pdf' token=o.token %}" target="_blank" rel="noopener">PDF</a>
                  {% if o.whatsapp_link %}
                    <a class="btn btn-success btn-sm" href="{{ o.whatsapp_link }}" target="_blank" rel="noopener">WhatsApp</a>
                  {% endif %}
                  <a class="btn btn-outline-dark btn-sm" href="{% url 'order_detail' o.pk %}" target="_blank" rel="noopener">Detalle</a>
                </div>
                <form class="d-flex flex-wrap align-items-center gap-2 mt-2" method="post" action="{% url 'add_part' o.pk %}">
                  {% csrf_token %}
                  <input class="form-control form-control-sm" name="sku" placeholder="SKU" style="max-width:110px" required>
                  <input class="form-control form-control-sm" name="qty" type="number" min="1" value="1" style="max-width:80px" required>
                  <input class="form-control form-control-sm" name="reason" placeholder="Motivo" style="max-width:160px">
                  <button class="btn btn-sm btn-primary" type="submit">Usar</button>
                </form>
                {% if o.allowed_next %}
                  <div class="d-flex flex-wrap gap-2 mt-2">
                    {% for code in o.allowed_next %}
                      {% for c,label in status_choices %}
                        {% if c == code %}
                          {% if c != 'DONE' or is_superuser %}
                            <form class="d-inline" method="post" action="{% url 'change_status' o.pk %}">
                              {% csrf_token %}
                              <input type="hidden" name="target" value="{{ code }}">
                              <button class="btn btn-sm btn-outline-info" type="submit">{{ label }}</button>
                            </form>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  </div>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="text-muted text-center" colspan="6">Sin resultados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card section">
    <nav class="mt-2" aria-label="Paginaci&oacute;n de &oacute;rdenes">
      <ul class="pagination pagination-sm mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?q={{ query }}&amp;status={{ status }}&amp;assignee={{ assignee }}&amp;from={{ dfrom }}&amp;to={{ dto }}&amp;page={{ page_obj.previous_page_number }}">&laquo; Anterior</a>
          </li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link text-muted">P&aacute;gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?q={{ query }}&amp;status={{ status }}&amp;assignee={{ assignee }}&amp;from={{ dfrom }}&amp;to={{ dto }}&amp;page={{ page_obj.next_page_number }}">Siguiente &raquo;</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}
