{% extends "base_nav.html" %}

{% load money %}
{% block title %}Cotización {{ order.folio }}{% endblock %}

{% block content %}
<div class="stack-lg">
  <div class="card section">
    <h1 class="mb-1">Cotización {{ order.folio }}</h1>
    <p class="text-muted mb-1">Cliente: {{ customer.name }}</p>
    <p class="text-muted mb-3">Equipo: {{ order.device.brand }} {{ order.device.model }}{% if order.device.serial %} ({{ order.device.serial }}){% endif %}</p>
    {% if approved_at_local %}
      <span class="badge bg-success-subtle text-success-emphasis">Aprobada el {{ approved_at_local|date:"Y-m-d H:i" }}</span>
    {% elif declined_at_local %}
      <span class="badge bg-danger-subtle text-danger-emphasis">Rechazada el {{ declined_at_local|date:"Y-m-d H:i" }}</span>
    {% endif %}
  </div>

  <div class="card section">
    <div class="d-flex flex-wrap justify-content-between gap-2">
      <div><strong>Estado:</strong> {{ status_label }}</div>
      <div><strong>Total:</strong> {{ estimate.total|default_if_none:0|money }}</div>
    </div>
  </div>

  <div class="card section">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Concepto</th>
            <th style="width:110px">Cantidad</th>
            <th style="width:130px">Precio unitario</th>
            <th style="width:130px">Importe</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>{{ item.description }}</td>
            <td>{{ item.qty }}</td>
            <td>{{ item.unit_price|money }}</td>
            <td>{{ item.line_total|money }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-muted text-center">No hay partidas registradas para esta cotización.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card section">
    <div class="d-flex flex-column gap-2">
      <div class="d-flex justify-content-between"><span>Subtotal</span><span>{{ estimate.subtotal|default_if_none:0|money }}</span></div>
      <div class="d-flex justify-content-between"><span>{{ tax_name }}</span><span>{{ estimate.tax|default_if_none:0|money }}</span></div>
      <div class="d-flex justify-content-between fw-semibold"><span>Total</span><span>{{ estimate.total|default_if_none:0|money }}</span></div>
    </div>
  </div>

  {% if note %}
    <div class="card section">
      <h2 class="h5">Nota del técnico</h2>
      <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ note }}</pre>
    </div>
  {% endif %}

  <div class="card section">
    <div class="d-flex flex-wrap gap-2">
      <form method="post" action="{% url 'estimate_approve' estimate.token %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-success"{% if not is_pending %} disabled{% endif %}>Aprobar cotización</button>
      </form>
      <form method="post" action="{% url 'estimate_decline' estimate.token %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger"{% if not is_pending %} disabled{% endif %}>Rechazar cotización</button>
      </form>
    </div>
    {% if not is_pending %}
      <p class="text-muted small mb-0 mt-3">Esta cotización ya tiene una respuesta registrada. Puedes consultar el estado en cualquier momento.</p>
    {% else %}
      <p class="text-muted small mb-0 mt-3">Selecciona una opción para confirmar tu decisión. Nos pondremos en contacto contigo enseguida.</p>
    {% endif %}
  </div>

  <div class="card section">
    <a class="btn btn-outline-primary" href="{% url 'public_status' order.token %}">Ver seguimiento de la orden</a>
  </div>
</div>
{% endblock %}
