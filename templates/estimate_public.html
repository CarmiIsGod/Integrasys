<!doctype html>
<html lang="es">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/brand/imago-azul.png?v=2' %}">
  <link rel="shortcut icon" href="{% static 'img/brand/imago-azul.png?v=2' %}">
  <title>Cotizacion {{ order.folio }}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px auto;max-width:760px;color:#1f2937;background:#f9fafb}
    h1{margin:0;font-size:28px;color:#111827}
    .muted{color:#6b7280;font-size:14px;margin-top:4px}
    .stamp{display:inline-block;margin-top:16px;padding:8px 18px;border-radius:999px;font-size:13px;font-weight:700;border:1px solid transparent}
    .stamp-ok{background:#dcfce7;color:#166534;border-color:#86efac}
    .stamp-bad{background:#fee2e2;color:#991b1b;border-color:#fca5a5}
    .card{margin-top:20px;padding:18px;border-radius:16px;background:#fff;box-shadow:0 1px 2px rgba(15,23,42,0.08)}
    table{width:100%;border-collapse:collapse;margin-top:18px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 2px rgba(15,23,42,0.08)}
    th,td{padding:11px 12px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background:#eef2ff;font-weight:600;color:#1f2937}
    tbody tr:last-child td{border-bottom:none}
    .status-options{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .status-options label{display:flex;align-items:center;gap:6px;font-size:14px;color:#374151}
    .status-options input{accent-color:#2563eb}
    .totals{margin-top:18px;display:grid;gap:8px;font-size:16px}
    .totals div{display:flex;justify-content:space-between}
    .totals .accepted{padding-top:8px;border-top:1px solid #e5e7eb;font-weight:700;color:#0f172a}
    .actions{margin-top:26px;display:flex;flex-wrap:wrap;gap:12px}
    form.inline{display:inline}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:600}
    .badge-ok{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .badge-muted{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    button{padding:12px 20px;border-radius:10px;border:0;font-size:15px;font-weight:600;cursor:pointer;text-transform:none;background:#2563eb;color:#fff;transition:opacity 0.2s ease}
    button.secondary{background:#ef4444}
    button.ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
    button[disabled]{opacity:0.45;cursor:not-allowed}
    .help{margin-top:16px;font-size:14px;color:#4b5563}
    a.link{color:#2563eb;font-weight:600;text-decoration:none}
    .note{margin-top:20px}
    .note h2{margin:0 0 6px 0;font-size:16px}
    .note pre{margin:0;background:#f8fafc;padding:14px;border-radius:10px;font-family:inherit;white-space:pre-wrap}
    .table-wrapper{overflow-x:auto;}
    @media(max-width:640px){
      body{margin:12px;}
      h1{font-size:24px;}
      .actions{flex-direction:column;}
      button{width:100%;text-align:center;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Cotizacion {{ order.folio }}</h1>
    <div class="muted">Cliente: {{ customer.name|default:"-" }}</div>
    <div class="muted">
      Equipos:
      {% if order_devices %}
        <ul style="margin:4px 0 0 18px;padding:0;">
          {% for device in order_devices %}
            <li>{{ device.brand }} {{ device.model }}{% if device.serial %} ({{ device.serial }}){% endif %}</li>
          {% endfor %}
        </ul>
      {% else %}
        <span class="muted">(sin dispositivos)</span>
      {% endif %}
    </div>
  </header>

  {% if approved_at_local %}
    <div class="stamp stamp-ok">APROBADA el {{ approved_at_local|date:"Y-m-d H:i" }}</div>
  {% elif declined_at_local %}
    <div class="stamp stamp-bad">RECHAZADA el {{ declined_at_local|date:"Y-m-d H:i" }}</div>
  {% endif %}

  <section class="card">
    <div><strong>Estado:</strong> {{ status_label }}</div>
    <div style="margin-top:6px"><strong>Total:</strong> ${{ total|floatformat:2 }}</div>
  </section>

  {% if messages %}
    <div class="card">
      <ul style="margin:0;padding-left:18px;color:#b91c1c;">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" action="{% url 'estimate_update_items' estimate.token %}">
    {% csrf_token %}
    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Concepto</th>
          <th style="width:110px">Cantidad</th>
          <th style="width:130px">Precio unitario</th>
          <th style="width:130px">Importe</th>
          <th style="width:220px">Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.description }}</td>
          <td>{{ item.qty }}</td>
          <td>${{ item.unit_price|floatformat:2 }}</td>
          <td>${{ item.line_total|floatformat:2 }}</td>
          <td data-item-id="{{ item.id }}">
            {% if not is_closed and item.status == item_status_pending %}
              <div class="status-options">
                <label><input type="radio" name="item-{{ item.id }}-status" value="{{ item_status_accepted }}"> Acepto</label>
                <label><input type="radio" name="item-{{ item.id }}-status" value="{{ item_status_rejected }}"> No acepto</label>
              </div>
            {% elif item.status == item_status_accepted %}
              <span class="badge badge-ok">Aceptado{% if item.decided_at %} el {{ item.decided_at|date:"Y-m-d H:i" }}{% endif %}</span>
            {% else %}
              <span class="badge badge-muted">No aceptado{% if item.decided_at %} el {{ item.decided_at|date:"Y-m-d H:i" }}{% endif %}</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">No hay partidas registradas para esta cotizacion.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>

    <div class="card">
      <div class="totals">
        <div><span>Subtotal cotizado</span><span>${{ subtotal|floatformat:2 }}</span></div>
        <div><span>IVA</span><span>${{ tax|floatformat:2 }}</span></div>
        <div><strong>Total cotizado</strong><strong>${{ total|floatformat:2 }}</strong></div>
        <div class="accepted"><span>Total aceptado</span><span>${{ accepted_total|floatformat:2 }}</span></div>
      </div>
    </div>

    <div class="actions">
      {% if not is_closed %}
        <button type="submit" class="ghost">Guardar seleccion</button>
      {% else %}
        <button type="button" class="ghost" disabled>Cotizacion cerrada</button>
      {% endif %}
    </div>
  </form>

  {% if note %}
    <section class="note">
      <h2>Nota del tecnico</h2>
      <pre>{{ note }}</pre>
    </section>
  {% endif %}

  {% if not is_closed %}
    <p class="help">Selecciona Acepto o No acepto en cada partida y guarda tu decision. Al guardar se cerrara esta cotizacion.</p>
  {% else %}
    <p class="help">Esta cotizacion ya esta cerrada. Si necesitas cambios o una nueva cotizacion, contactanos.</p>
  {% endif %}

  <p class="help"><a class="link" href="{% url 'public_status' order.token %}">Ver seguimiento de la orden</a></p>
</body>
</html>

