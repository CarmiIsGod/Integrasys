<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Cotizacion {{ order.folio }}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px auto;max-width:760px;color:#1f2937;background:#f9fafb}
    h1{margin:0;font-size:28px;color:#111827}
    .muted{color:#6b7280;font-size:14px;margin-top:4px}
    .stamp{display:inline-block;margin-top:16px;padding:8px 18px;border-radius:999px;font-size:13px;font-weight:700;border:1px solid transparent}
    .stamp-ok{background:#dcfce7;color:#166534;border-color:#86efac}
    .stamp-bad{background:#fee2e2;color:#991b1b;border-color:#fca5a5}
    .card{margin-top:20px;padding:18px;border-radius:16px;background:#fff;box-shadow:0 1px 2px rgba(15,23,42,0.08)}
    table{width:100%;border-collapse:collapse;margin-top:18px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 2px rgba(15,23,42,0.08)}
    th,td{padding:11px 12px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background:#eef2ff;font-weight:600;color:#1f2937}
    tbody tr:last-child td{border-bottom:none}
    .totals{margin-top:18px;display:grid;gap:8px;font-size:16px}
    .totals div{display:flex;justify-content:space-between}
    .actions{margin-top:26px;display:flex;flex-wrap:wrap;gap:12px}
    form.inline{display:inline}
    button{padding:12px 20px;border-radius:10px;border:0;font-size:15px;font-weight:600;cursor:pointer;text-transform:none;background:#2563eb;color:#fff;transition:opacity 0.2s ease}
    button.secondary{background:#ef4444}
    button[disabled]{opacity:0.45;cursor:not-allowed}
    .help{margin-top:16px;font-size:14px;color:#4b5563}
    a.link{color:#2563eb;font-weight:600;text-decoration:none}
    .note{margin-top:20px}
    .note h2{margin:0 0 6px 0;font-size:16px}
    .note pre{margin:0;background:#f8fafc;padding:14px;border-radius:10px;font-family:inherit;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <h1>Cotizacion {{ order.folio }}</h1>
    <div class="muted">Cliente: {{ customer.name }}</div>
    <div class="muted">Equipo: {{ order.device.brand }} {{ order.device.model }}{% if order.device.serial %} ({{ order.device.serial }}){% endif %}</div>
  </header>

  {% if approved_at_local %}
    <div class="stamp stamp-ok">APROBADA el {{ approved_at_local|date:"Y-m-d H:i" }}</div>
  {% elif declined_at_local %}
    <div class="stamp stamp-bad">RECHAZADA el {{ declined_at_local|date:"Y-m-d H:i" }}</div>
  {% endif %}

  <section class="card">
    <div><strong>Estado:</strong> {{ status_label }}</div>
    <div style="margin-top:6px"><strong>Total:</strong> ${{ total|floatformat:2 }}</div>
  </section>

  <table>
    <thead>
      <tr>
        <th>Concepto</th>
        <th style="width:110px">Cantidad</th>
        <th style="width:130px">Precio unitario</th>
        <th style="width:130px">Importe</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td>{{ item.description }}</td>
        <td>{{ item.qty }}</td>
        <td>${{ item.unit_price|floatformat:2 }}</td>
        <td>${{ item.line_total|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4">No hay partidas registradas para esta cotizacion.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="card">
    <div class="totals">
      <div><span>Subtotal</span><span>${{ subtotal|floatformat:2 }}</span></div>
      <div><span>IVA</span><span>${{ tax|floatformat:2 }}</span></div>
      <div><strong>Total</strong><strong>${{ total|floatformat:2 }}</strong></div>
    </div>
  </div>

  {% if note %}
    <section class="note">
      <h2>Nota del tecnico</h2>
      <pre>{{ note }}</pre>
    </section>
  {% endif %}

  <div class="actions">
    <form method="post" action="{% url 'estimate_approve' estimate.token %}" class="inline">
      {% csrf_token %}
      <button type="submit"{% if not is_pending %} disabled{% endif %}>Aprobar cotizacion</button>
    </form>
    <form method="post" action="{% url 'estimate_decline' estimate.token %}" class="inline">
      {% csrf_token %}
      <button type="submit" class="secondary"{% if not is_pending %} disabled{% endif %}>Rechazar cotizacion</button>
    </form>
  </div>

  {% if not is_pending %}
    <p class="help">Esta cotizacion ya tiene una respuesta registrada. Puedes volver a consultar el estado de tu servicio en cualquier momento.</p>
  {% else %}
    <p class="help">Selecciona una opcion para confirmar tu decision. Nos pondremos en contacto contigo enseguida.</p>
  {% endif %}

  <p class="help"><a class="link" href="{% url 'public_status' order.token %}">Ver seguimiento de la orden</a></p>
</body>
</html>
