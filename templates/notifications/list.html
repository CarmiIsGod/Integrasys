<!doctype html>
{% load notification_extras %}
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Notificaciones | Integrasys</title>
  <style>
    body{font-family:Segoe UI,Arial,sans-serif;background:#f5f7fb;margin:0;padding:24px;color:#1e293b;}
    h1{margin:0 0 12px;font-size:28px;}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.08);border:1px solid #e2e8f0;margin-bottom:16px;}
    .muted{color:#64748b;font-size:14px;}
    .notif-list{display:grid;gap:14px;margin-top:18px;}
    .notif{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#fff;box-shadow:0 4px 12px rgba(15,23,42,0.05);}
    .notif--unread{border-color:#93c5fd;background:#eff6ff;}
    .notif h2{margin:0;font-size:18px;color:#1d4ed8;}
    .notif time{display:block;margin-top:6px;font-size:12px;color:#64748b;}
    .pill{display:inline-block;background:#1d4ed8;color:#fff;font-size:12px;padding:2px 8px;border-radius:999px;margin-right:6px;}
    .btn{display:inline-block;background:#1d4ed8;color:#fff;padding:8px 14px;border-radius:999px;text-decoration:none;font-weight:600;border:none;cursor:pointer;}
    .btn-ghost{background:#e2e8f0;color:#1e293b;}
  </style>
</head>
<body>
  {% include "partials/reception_nav.html" %}
  <main>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;">
      <div>
        <h1>Notificaciones</h1>
        <p class="muted">Resumen de eventos recientes. {{ unread_count }} sin leer.</p>
      </div>
      <a class="btn-ghost btn" href="{% url 'reception_home' %}">&larr; Regresar</a>
    </div>

    <div class="card">
      <form method="post" action="{% url 'notifications_mark_all_read' %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{% url 'notifications_list' %}">
        <button type="submit" class="btn" {% if not unread_count %}disabled style="opacity:.6;cursor:not-allowed;"{% endif %}>
          Marcar todas como le&iacute;das
        </button>
      </form>
    </div>

    <section class="notif-list">
      {% for notif in notifications %}
        <article class="notif {% if not notif.seen_at %}notif--unread{% endif %}">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
            <h2>
              {% if notif.kind == "estimate" %}
                {{ notif.title|default:"Cotizacion" }}
              {% elif notif.kind == "payment" %}
                {{ notif.title|default:"Pago registrado" }}
              {% elif notif.kind == "stock" %}
                {{ notif.title|default:"Stock" }}
              {% else %}
                {{ notif.title|default:"Actualizacion" }}
              {% endif %}
            </h2>
            <span class="pill">{{ notif.kind|upper }}</span>
          </div>

          <div style="margin-top:8px;display:grid;gap:4px;">
            {% if notif.kind == "payment" %}
              {% payload_first notif.payload "order_folio" "order_id" "order" as order_ref %}
              {% if order_ref %}<div>Orden: {{ order_ref }}</div>{% endif %}
              {% payload_first notif.payload "customer" "customer_name" as customer_name %}
              {% if customer_name %}<div>Cliente: {{ customer_name }}</div>{% endif %}
              {% payload_first notif.payload "device" "device_label" "equipment" as device_label %}
              {% if device_label %}<div>Equipo: {{ device_label }}</div>{% endif %}
              {% with method=notif.payload|payload_get:"method" %}
                {% if method %}<div>M&eacute;todo: {{ method }}</div>{% endif %}
              {% endwith %}
              {% with amount=notif.payload|payload_get:"amount" %}
                {% if amount %}<div>Monto: ${{ amount }}</div>{% endif %}
              {% endwith %}
              {% with balance=notif.payload|payload_get:"new_balance" %}
                {% if balance %}<div>Saldo: ${{ balance }}</div>{% endif %}
              {% endwith %}
              {% with reference=notif.payload|payload_get:"reference" %}
                {% if reference %}<div>Referencia: {{ reference }}</div>{% endif %}
              {% endwith %}

            {% elif notif.kind == "estimate" %}
              {% payload_first notif.payload "order_folio" "order_id" "order" as order_ref %}
              {% if order_ref %}<div>Orden: {{ order_ref }}</div>{% endif %}
              {% payload_first notif.payload "customer" "customer_name" as customer_name %}
              {% if customer_name %}<div>Cliente: {{ customer_name }}</div>{% endif %}
              {% payload_first notif.payload "device" "device_label" "equipment" as device_label %}
              {% if device_label %}<div>Equipo: {{ device_label }}</div>{% endif %}
              {% with total=notif.payload|payload_get:"total" %}
                {% if total %}<div>Total: ${{ total }}</div>{% endif %}
              {% endwith %}

            {% elif notif.kind == "stock" %}
              {% payload_first notif.payload "item_name" "name" as product_name %}
              {% if product_name %}<div>Producto: {{ product_name }}</div>{% endif %}
              {% with sku=notif.payload|payload_get:"sku" %}
                {% if sku %}<div>SKU: {{ sku }}</div>{% endif %}
              {% endwith %}
              {% with qty=notif.payload|payload_get:"qty" %}
                {% if qty|has_value %}<div>Quedan: {{ qty }}</div>{% endif %}
              {% endwith %}
              {% with min_qty=notif.payload|payload_get:"min_qty" %}
                {% if min_qty|has_value %}<div>M&iacute;nimo: {{ min_qty }}</div>{% endif %}
              {% endwith %}
              {% with location=notif.payload|payload_get:"location" %}
                {% if location %}<div>Ubicaci&oacute;n: {{ location }}</div>{% endif %}
              {% endwith %}

            {% else %}
              {% payload_first notif.payload "order_folio" "order_id" "order" as order_ref %}
              {% if order_ref %}<div>Orden: {{ order_ref }}</div>{% endif %}
              {% payload_first notif.payload "customer" "customer_name" as customer_name %}
              {% if customer_name %}<div>Cliente: {{ customer_name }}</div>{% endif %}
              {% payload_first notif.payload "device" "device_label" "equipment" as device_label %}
              {% if device_label %}<div>Equipo: {{ device_label }}</div>{% endif %}
              {% payload_first notif.payload "status_display" "status" as status_label %}
              {% if status_label %}<div>Estado: {{ status_label }}</div>{% endif %}
              {% with changed_by=notif.payload|payload_get:"changed_by" %}
                {% if changed_by %}<div>Actualizado por: {{ changed_by }}</div>{% endif %}
              {% endwith %}
            {% endif %}
          </div>

          {% if notif.payload.error %}
            <div style="color:#b91c1c;margin-top:6px;">Error: {{ notif.payload.error }}</div>
          {% endif %}

          <time>Creado: {{ notif.created_at|date:"Y-m-d H:i" }}{% if notif.seen_at %} &middot; Le&iacute;do: {{ notif.seen_at|date:"Y-m-d H:i" }}{% endif %}</time>
        </article>
      {% empty %}
        <p class="muted">Sin notificaciones registradas.</p>
      {% endfor %}
    </section>
  </main>
</body>
</html>
