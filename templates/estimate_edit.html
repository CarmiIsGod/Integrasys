{% extends "base_nav.html" %}

{% load money %}
{% block title %}Cotización orden {{ order.folio }}{% endblock %}

{% block content %}
<div class="stack-lg">
  <div class="card section">
    <h1 class="mb-1">Cotización orden {{ order.folio }}</h1>
    <div class="text-muted mb-3">Estado: {{ status_label }}</div>

    <form method="post" id="estimate-form" class="stack">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Descripción</th>
              <th style="width:100px">Cantidad</th>
              <th style="width:140px">Precio unitario</th>
              <th style="width:160px">SKU (opcional)</th>
              <th style="width:80px">Acciones</th>
            </tr>
          </thead>
          <tbody id="items-body">
            {% for item in items %}
            <tr>
              <td><input name="description" value="{{ item.description }}" required class="form-control"></td>
              <td><input name="qty" type="number" min="1" value="{{ item.qty }}" required class="form-control"></td>
              <td><input name="unit_price" type="number" min="0" step="0.01" value="{{ item.unit_price }}" required class="form-control"></td>
              <td><input name="inventory_sku" list="inventory-skus" value="{{ item.inventory_sku }}" placeholder="SKU" class="form-control"></td>
              <td><button type="button" class="btn btn-link text-danger p-0 remove-row">Quitar</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <button type="button" id="add-row" class="btn btn-outline-primary btn-sm align-self-start">Agregar partida</button>

      <div class="form-check my-2">
        <input class="form-check-input" type="checkbox" name="include_tax" id="include_tax" {% if include_tax %}checked{% endif %}>
        <label class="form-check-label" for="include_tax">Incluir {{ tax_name }} ({{ tax_rate_pct }}%)</label>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <label class="form-label">Subtotal</label>
          <input class="form-control" value="{{ estimate.subtotal|default_if_none:0|money }}" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">{{ tax_name }}</label>
          <input class="form-control" value="{{ estimate.tax|default_if_none:0|money }}" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Total</label>
          <input class="form-control fw-semibold" value="{{ estimate.total|default_if_none:0|money }}" readonly>
        </div>
      </div>
      <p class="text-muted small mb-3">El pago maximo permitido se valida contra el Total.</p>

      <div>
        <label class="form-label" for="note"><b>Nota para el cliente</b></label>
        <textarea id="note" name="note" rows="3" class="form-control" placeholder="Detalle adicional opcional">{{ note }}</textarea>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary">Guardar cotización</button>
        <a class="btn btn-outline-secondary" href="{% url 'order_detail' order.pk %}">Volver a la orden</a>
      </div>
    </form>
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <h2 class="h5 mb-3">Resumen guardado</h2>
      <dl class="row mb-0">
        <dt class="col-sm-4">Subtotal</dt>
        <dd class="col-sm-8">{{ estimate.subtotal|default_if_none:0|money }}</dd>
        <dt class="col-sm-4">{{ tax_name }}</dt>
        <dd class="col-sm-8">{{ estimate.tax|default_if_none:0|money }}</dd>
        <dt class="col-sm-4">Total</dt>
        <dd class="col-sm-8 fw-semibold">{{ estimate.total|default_if_none:0|money }}</dd>
      </dl>
    </div>
    <div class="card">
      <h2 class="h5 mb-3">Acciones</h2>
      <div class="d-flex flex-wrap gap-2">
        {% if has_saved_items %}
          <form method="post" action="{% url 'estimate_send' order.pk %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">Enviar cotización</button>
          </form>
        {% endif %}
        {% if public_estimate_url %}
          <a class="btn btn-outline-primary" href="{{ public_estimate_url }}" target="_blank">Ver enlace público</a>
        {% endif %}
      </div>
    </div>
  </div>

  <datalist id="inventory-skus">
    {% for item in inventory_items %}
      <option value="{{ item.sku }}">{{ item.name }}</option>
    {% endfor %}
  </datalist>

  <template id="row-template">
    <tr>
      <td><input name="description" required class="form-control"></td>
      <td><input name="qty" type="number" min="1" value="1" required class="form-control"></td>
      <td><input name="unit_price" type="number" min="0" step="0.01" value="0.00" required class="form-control"></td>
      <td><input name="inventory_sku" list="inventory-skus" placeholder="SKU" class="form-control"></td>
      <td><button type="button" class="btn btn-link text-danger p-0 remove-row">Quitar</button></td>
    </tr>
  </template>

  <script>
    (function(){
      const body = document.getElementById('items-body');
      const template = document.getElementById('row-template').content;
      const addRowBtn = document.getElementById('add-row');

      function addRow(values) {
        const clone = document.importNode(template, true);
        if (values) {
          clone.querySelector('input[name="description"]').value = values.description || '';
          clone.querySelector('input[name="qty"]').value = values.qty || '1';
          clone.querySelector('input[name="unit_price"]').value = values.unit_price || '0.00';
          clone.querySelector('input[name="inventory_sku"]').value = values.inventory_sku || '';
        }
        body.appendChild(clone);
      }

      addRowBtn.addEventListener('click', function(){
        addRow();
      });

      body.addEventListener('click', function(evt){
        if (evt.target.classList.contains('remove-row')) {
          const row = evt.target.closest('tr');
          if (row) {
            row.remove();
            if (!body.children.length) {
              addRow();
            }
          }
        }
      });

      if (!body.children.length) {
        addRow();
      }
    })();
  </script>
</div>
{% endblock %}
