<!doctype html>
<html lang="es">
{% load money tz %}
<head>
  <meta charset="utf-8">
  <title>Recibo de pago &mdash; {{ order.folio }}</title>
  <style>
    @page { margin: 1.5cm; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      color: #1a1a1a;
      font-size: 12px;
      line-height: 1.5;
      background-color: #ffffff;
    }
    h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 4px 0;
      color: #111111;
    }
    .header-table {
      width: 100%;
      border-bottom: 1px solid #d7d7d7;
      padding-bottom: 14px;
      margin-bottom: 18px;
    }
    .company-name {
      font-size: 16px;
      font-weight: 600;
      color: #111111;
      margin: 0;
    }
    .company-meta {
      font-size: 11px;
      color: #4a4a4a;
      margin-top: 2px;
    }
    .meta-block {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e3e3e3;
    }
    .meta-item {
      font-size: 12px;
      margin: 2px 0;
    }
    .meta-label {
      font-weight: 600;
      color: #111111;
      margin-right: 4px;
    }
    .qr-box {
      text-align: right;
      width: 140px;
    }
    .qr-img {
      display: inline-block;
      width: 120px;
      height: 120px;
      object-fit: contain;
      border: 1px solid #d7d7d7;
      padding: 6px;
      border-radius: 4px;
      background: #fafafa;
    }
    table.payments {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    table.payments th {
      text-align: left;
      font-weight: 600;
      color: #111111;
      border-bottom: 1px solid #d7d7d7;
      padding: 6px 4px;
      background-color: #f4f4f4;
    }
    table.payments td {
      padding: 6px 4px;
      border-bottom: 1px solid #ededed;
      color: #333333;
    }
    table.payments tr:last-child td {
      border-bottom: none;
    }
    .totals {
      margin-top: 24px;
      border: 1px solid #d7d7d7;
      border-radius: 6px;
      overflow: hidden;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e3e3e3;
      background-color: #fbfbfb;
    }
    .totals-row:last-child {
      border-bottom: none;
    }
    .totals-label {
      font-size: 13px;
      font-weight: 600;
      color: #4a4a4a;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    .totals-value {
      font-size: 20px;
      font-weight: 700;
      color: #111111;
    }
    .totals-value.balance {
      color: #b00020;
    }
    .footer-note {
      margin-top: 30px;
      font-size: 11px;
      color: #4a4a4a;
      border-top: 1px solid #e3e3e3;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <table class="header-table">
    <tr>
      <td>
        {% if COMPANY_LOGO_URL %}
          <img src="{{ COMPANY_LOGO_URL }}" alt="{{ COMPANY_NAME }}" style="max-width: 180px; max-height: 70px; margin-bottom: 8px;" />
        {% endif %}
        <p class="company-name">{{ COMPANY_NAME }}</p>
        {% if COMPANY_RFC or COMPANY_PHONE %}
          <div class="company-meta">
            {% if COMPANY_RFC %}RFC: {{ COMPANY_RFC }}{% endif %}
            {% if COMPANY_RFC and COMPANY_PHONE %}&nbsp;&nbsp;|&nbsp;&nbsp;{% endif %}
            {% if COMPANY_PHONE %}Tel: {{ COMPANY_PHONE }}{% endif %}
          </div>
        {% endif %}
      </td>
      <td class="qr-box">
        {% if public_qr_url %}
          <img src="{{ public_qr_url }}" alt="QR de seguimiento" class="qr-img" />
        {% elif qr_b64 %}
          <img src="data:image/png;base64,{{ qr_b64 }}" alt="QR de seguimiento" class="qr-img" />
        {% endif %}
      </td>
    </tr>
  </table>

  <div class="meta-block">
    <h1>Recibo de pago &mdash; {{ order.folio }}</h1>
    <p class="meta-item"><span class="meta-label">Fecha de emision:</span>{{ issued_at_display }}</p>
    <p class="meta-item"><span class="meta-label">Cliente:</span>{{ customer_name }}</p>
    <p class="meta-item"><span class="meta-label">Equipo:</span>{{ equipment_display }}</p>
  </div>

  <div>
    <p class="meta-label" style="margin-bottom: 6px;">Pagos registrados</p>
    {% if payments %}
      <table class="payments">
        <thead>
          <tr>
            <th style="width: 25%;">Fecha</th>
            <th style="width: 20%;">M&eacute;todo</th>
            <th style="width: 35%;">Referencia</th>
            <th style="width: 20%; text-align: right;">Monto</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
            <tr>
              <td>{% if payment.created_at %}{{ payment.created_at|localtime|date:"d/m/Y H:i" }}{% endif %}</td>
              <td>{{ payment.method }}</td>
              <td>{{ payment.reference }}</td>
              <td style="text-align: right;">{{ payment.amount|money }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="font-size: 12px; color: #666666; margin: 0;">No hay pagos registrados para esta orden.</p>
    {% endif %}
  </div>

{% if has_payments %}
  <h4 style="margin:16px 0 8px;">Totales</h4>
  <div style="border:1px solid #ddd;border-radius:6px;padding:10px;">
    <div style="display:flex;gap:12px;align-items:center;margin:6px 0;">
      <div style="width:140px;color:#666;">Aprobado</div>
      <div style="flex:1;border:1px solid #e4e4e4;border-radius:4px;padding:6px 10px;">{{ approved|money }}</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;margin:6px 0;">
      <div style="width:140px;color:#666;">Pagado</div>
      <div style="flex:1;border:1px solid #e4e4e4;border-radius:4px;padding:6px 10px;">{{ paid|money }}</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;margin:6px 0;">
      <div style="width:140px;color:#666;">Saldo</div>
      <div style="flex:1;border:1px solid #e4e4e4;border-radius:4px;padding:6px 10px;font-weight:600;">
        {{ balance|money }}
      </div>
    </div>
  </div>
{% endif %}

  <div class="footer-note">
    Consulta estado y comprobantes en: {{ public_url }}
  </div>
</body>
</html>
