{% extends "base_nav.html" %}
{% load static %}
{% load ui %} {# status_badge #}

{% block title %}{{ order.folio }}{% endblock %}
{% block content %}
<div class="stack-lg">
  <h1 class="mb-3">Orden {{ order.folio }}
    <span class="badge bg-{{ order.status|status_badge }}">{{ order.get_status_display }}</span>
  </h1>

  <div class="grid grid-2 section">
    <div class="card">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Resumen</h5>
        <small class="text-muted">Ingreso: {{ order.checkin_at|date:"Y-m-d H:i" }}</small>
      </div>
      <div class="row mt-2 g-2">
        <div class="col-6">
          <div class="text-muted small">Total aprobado</div>
          <div class="fw-semibold">${{ order.approved_total }}</div>
        </div>
        <div class="col-6">
          <div class="text-muted small">Pagado</div>
          <div class="fw-semibold">${{ order.paid_total }}</div>
        </div>
        <div class="col-6">
          <div class="text-muted small">Saldo</div>
          <div class="fw-semibold">${{ order.balance }}</div>
        </div>
        <div class="col-6">
          <div class="text-muted small">Asignado a</div>
          <div class="fw-semibold">{{ order.assigned_to|default:"&mdash;" }}</div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        {# Ajusta los urlname si en tu proyecto usan nombres distintos #}
        <a class="btn btn-outline-primary btn-sm" target="_blank" href="{% url 'public_status' order.token %}">
          <i class="bi bi-box-arrow-up-right"></i> Ver p&uacute;blico
        </a>
        {% if pdf_url %}<a class="btn btn-outline-secondary btn-sm" href="{{ pdf_url }}"><i class="bi bi-file-earmark-pdf"></i> PDF</a>{% endif %}
        {% if whatsapp_url %}<a class="btn btn-success btn-sm" target="_blank" href="{{ whatsapp_url }}"><i class="bi bi-whatsapp"></i> WhatsApp</a>{% endif %}
      </div>
    </div>

    <div class="card">
      <h5>Cliente y Equipo</h5>
      <div class="mt-2">
        <div class="fw-semibold">Cliente</div>
        <div>{{ order.device.customer.name }}</div>
        <div class="text-muted small">Tel: {{ order.device.customer.phone }} &middot; Email: {{ order.device.customer.email }}</div>
        <hr class="my-2">
        <div class="fw-semibold">Equipo</div>
        <div>{{ order.device.brand }} {{ order.device.model }} ({{ order.device.serial }})</div>
      </div>
    </div>

    <div class="card">
      <h5>Cotizaci&oacute;n</h5>
      <div class="mt-2">
        <div class="text-muted small">Estado</div>
        <div class="fw-semibold">{% if order.estimate %}{{ order.estimate.total }} ({{ order.estimate.get_status_display|default:"sin cotizaci&oacute;n" }}){% else %}sin cotizaci&oacute;n{% endif %}</div>
        <div class="mt-2">
          <a class="btn btn-primary btn-sm" href="{% url 'estimate_edit' order.pk %}"><i class="bi bi-pencil-square"></i> Editar cotizaci&oacute;n</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card section">
    <h5>Pagos</h5>
    {# Reusa tu tabla/forma existentes; solo envu&eacute;lvelos en esta card #}
    {{ payments_block|safe }}
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <h5>Notas internas</h5>
      {{ notes_block|safe }}
    </div>
    <div class="card">
      <h5>Cambiar estado</h5>
      {{ status_block|safe }}
    </div>
    <div class="card">
      <h5>Asignar t&eacute;cnico</h5>
      {{ assign_block|safe }}
    </div>
    <div class="card">
      <h5>Refacciones usadas</h5>
      {{ inventory_block|safe }}
    </div>
    <div class="card">
      <h5>Historial</h5>
      {{ history_block|safe }}
    </div>
  </div>

  <div class="card section">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Adjuntos</h5>
    </div>

    <form class="row g-2 mt-2" method="post" enctype="multipart/form-data" action="{% url 'add_attachment' pk=order.pk %}">
      {% csrf_token %}
      <div class="col-md-6">
        <input class="form-control" type="file" name="attachments" accept="image/*,.pdf" multiple required>
        <div class="form-text text-muted">Puedes seleccionar varios archivos. MÃ¡x 10 MB c/u.</div>
      </div>
      <div class="col-md-3 form-check d-flex align-items-center">
        <input class="form-check-input" type="checkbox" name="is_public" id="is_public">
        <label class="form-check-label ms-2" for="is_public">Visible en p&uacute;blico</label>
      </div>
      <div class="col-md-3 text-end"><button class="btn btn-primary"><i class="bi bi-upload"></i> Subir</button></div>
    </form>

    <div class="d-flex flex-wrap gap-3 mt-3">
      {% for a in attachments %}
        <div class="border rounded p-2">
          {% if a.kind == "image" %}
            <a href="{{ a.file.url }}" target="_blank"><img src="{{ a.file.url }}" style="width:140px;height:auto;border-radius:8px"></a>
          {% else %}
            <a href="{{ a.file.url }}" target="_blank"><i class="bi bi-file-earmark-text"></i> {{ a.file.name|slice:"-40:" }}</a>
          {% endif %}
          <div class="text-muted small mt-1">{{ a.created_at|date:"Y-m-d H:i" }} &middot; {% if a.is_public %}P&uacute;blico{% else %}Interno{% endif %}</div>
          <form method="post" action="{% url 'delete_attachment' pk=order.pk att_id=a.id %}" onsubmit="return confirm('&#191;Eliminar adjunto?')">
            {% csrf_token %}<button class="btn btn-sm btn-outline-danger mt-1"><i class="bi bi-trash"></i> Eliminar</button>
          </form>
        </div>
      {% empty %}
        <div class="text-muted">Sin adjuntos.</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
