<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nueva orden | Integrasys</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body{font-family:Segoe UI,Arial,sans-serif;background:#f5f7fb;margin:0;padding:24px;color:#1e293b;}
    h1{margin:0 0 12px;font-size:28px;}
    h2{margin:0 0 10px;font-size:20px;color:#1d4ed8;}
    h3{margin:0;font-size:18px;}
    .muted{color:#64748b;font-size:14px;margin:0;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:16px;}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(15,23,42,0.08);border:1px solid #e2e8f0;}
    .customer-search-results{border:1px solid #cbd5f5;border-radius:10px;margin-top:8px;display:flex;flex-direction:column;gap:4px;padding:6px;background:#f8fbff;max-height:220px;overflow:auto;}
    .customer-search-results[hidden]{display:none;}
    .customer-search-result{display:flex;flex-direction:column;align-items:flex-start;border:1px solid transparent!important;background:#f8fafc!important;color:#0f172a!important;text-align:left;padding:8px;border-radius:8px;cursor:pointer;gap:2px;font-size:14px;}
    .customer-search-result:hover{background:#e0edff!important;border-color:#bfdbfe!important;color:#0f172a!important;}
    .customer-search-result.is-empty{cursor:default;color:#64748b;}
    .customer-search-result strong{color:#1d4ed8;margin-bottom:2px;}
    .customer-search-result span{color:#475569;font-size:12px;}
    .customer-search-selected{display:inline-flex;align-items:center;gap:8px;background:#dcfce7;color:#166534;padding:6px 10px;border-radius:999px;font-size:13px;margin-top:8px;}
    .customer-search-selected[hidden]{display:none;}
    label{display:block;font-weight:600;margin-bottom:4px;color:#1e293b;}
    input,textarea{width:100%;padding:9px;border:1px solid #cbd5f5;border-radius:8px;font-family:inherit;box-sizing:border-box;}
    textarea{resize:vertical;min-height:120px;}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px;flex-wrap:wrap;}
    .btn{display:inline-block;background:#1d4ed8;color:#fff;padding:8px 14px;border-radius:999px;text-decoration:none;font-weight:600;}
    .btn-ghost{background:#e2e8f0;color:#1e293b;}
    button{background:#1d4ed8;color:#fff;border:none;border-radius:999px;padding:9px 16px;font-weight:600;cursor:pointer;}
    ul.messages{list-style:none;padding:0;margin:12px 0;}
    ul.messages li{background:#dbeafe;border:1px solid #93c5fd;color:#1d4ed8;padding:10px;border-radius:10px;font-weight:500;margin-bottom:6px;}
    .device-card{border:1px solid #cbd5f5;border-radius:12px;padding:16px;background:#f8fbff;}
    .device-card.is-hidden{display:none!important;}
    .device-card__header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;}
    .device-delete-field{display:none;}
    .js-remove-device{display:none;}
    @media (max-width:900px){
      body{padding:16px;}
      h1{font-size:24px;}
      .grid{grid-template-columns:1fr;}
      .device-card__header{flex-direction:column;align-items:flex-start;gap:6px;}
      .actions{flex-direction:column;align-items:flex-start;}
      .btn,.btn-ghost,button{width:100%;text-align:center;}
      input,textarea{font-size:15px;}
    }
    @media (max-width:520px){
      body{padding:12px;}
      .js-remove-device{width:100%;}
    }
  </style>
</head>
<body>
  {% include "partials/reception_nav.html" %}
  <main>
    <div class="actions" style="justify-content:space-between;margin-bottom:12px;">
      <div>
        <h1>Nueva orden</h1>
        <p class="muted">Captura los datos del cliente y los equipos que ingresan en la misma orden.</p>
      </div>
      <a href="{% url 'reception_home' %}" class="btn btn-ghost">&larr; Inicio</a>
    </div>

    {% if messages %}
      <ul class="messages">
        {% for m in messages %}<li>{{ m }}</li>{% endfor %}
      </ul>
    {% endif %}

    <form method="post" id="new-order-form">
      {% csrf_token %}
      <div class="grid">
        <div class="card">
          <h2>Cliente</h2>
          <label>Buscar cliente existente</label>
          <input id="customer-search" type="text" placeholder="Nombre, telefono o correo..." data-search-url="{% url 'reception_customer_search' %}">
          <div id="customer-search-results" class="customer-search-results" hidden></div>
          <div id="customer-selected-pill" class="customer-search-selected" {% if not prefill.customer_id %}hidden{% endif %}>
            Cliente existente seleccionado
          </div>
          <input type="hidden" name="customer_id" id="customer-id" value="{{ prefill.customer_id }}">
          <p class="muted" style="margin-top:8px;">Selecciona un cliente existente o captura uno nuevo abajo.</p>
          <label>Nombre*</label>
          <input name="name" value="{{ prefill.name }}" required placeholder="Nombre completo">
          <label style="margin-top:12px;">Tel&eacute;fono</label>
          <input name="phone" value="{{ prefill.phone }}" placeholder="Opcional">
          <label style="margin-top:12px;">Email</label>
          <input type="email" name="email" value="{{ prefill.email }}" placeholder="cliente@correo.com">
          <p class="muted" style="margin-top:10px;">Si los datos coinciden con un cliente existente se reutilizar&aacute;n autom&aacute;ticamente.</p>
        </div>
        <div class="card">
          <h2>Notas generales</h2>
          <label>Notas</label>
          <textarea name="notes" placeholder="Comentarios generales, accesorios, prioridad...">{{ prefill.notes }}</textarea>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div>
            <h2>Dispositivos</h2>
            <p class="muted" style="margin:4px 0 0;">Agrega cada dispositivo (m&aacute;x. {{ device_formset.max_num }} por orden).</p>
          </div>
          <button type="button" class="btn btn-ghost" id="add-device-btn">A&ntilde;adir dispositivo</button>
        </div>
        {{ device_formset.management_form }}
        <div id="device-formset" style="display:flex;flex-direction:column;gap:12px;margin-top:16px;">
          {% for form in device_formset %}
            <div class="device-card{% if form.DELETE.value %} is-hidden{% endif %}" data-device-form data-device-index="{{ forloop.counter0 }}">
              <div class="device-card__header">
                <h3 style="color:#1d4ed8;">Dispositivo {{ forloop.counter }}</h3>
                <button type="button" class="btn btn-ghost js-remove-device">Quitar dispositivo</button>
              </div>
              {{ form.non_field_errors }}
              <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                <div>
                  <label>Marca*</label>
                  {{ form.brand }}
                  {% for error in form.brand.errors %}<div class="muted" style="color:#b91c1c;">{{ error }}</div>{% endfor %}
                </div>
                <div>
                  <label>Modelo*</label>
                  {{ form.model }}
                  {% for error in form.model.errors %}<div class="muted" style="color:#b91c1c;">{{ error }}</div>{% endfor %}
                </div>
                <div>
                  <label>Serie</label>
                  {{ form.serial }}
                  {% for error in form.serial.errors %}<div class="muted" style="color:#b91c1c;">{{ error }}</div>{% endfor %}
                </div>
              </div>
              <label style="margin-top:12px;display:block;">Descripci&oacute;n / Falla</label>
              {{ form.notes }}
              {% for error in form.notes.errors %}<div class="muted" style="color:#b91c1c;">{{ error }}</div>{% endfor %}
              {% if form.DELETE %}
                <span class="device-delete-field">{{ form.DELETE }}</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="actions" style="margin-top:16px;">
        <button type="submit">Crear orden</button>
      </div>
    </form>

    <template id="device-form-template">
      <div class="device-card" data-device-form data-device-index="__prefix__">
        <div class="device-card__header">
          <h3 style="color:#1d4ed8;">Dispositivo __NUM__</h3>
          <button type="button" class="btn btn-ghost js-remove-device">Quitar dispositivo</button>
        </div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
          <div>
            <label>Marca*</label>
            {{ device_formset.empty_form.brand }}
          </div>
          <div>
            <label>Modelo*</label>
            {{ device_formset.empty_form.model }}
          </div>
          <div>
            <label>Serie</label>
            {{ device_formset.empty_form.serial }}
          </div>
        </div>
        <label style="margin-top:12px;display:block;">Descripci&oacute;n / Falla</label>
        {{ device_formset.empty_form.notes }}
        {% if device_formset.empty_form.DELETE %}
          <span class="device-delete-field">{{ device_formset.empty_form.DELETE }}</span>
        {% endif %}
      </div>
    </template>
  </main>
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      const searchInput = document.getElementById("customer-search");
      if (searchInput) {
        const searchUrl = searchInput.dataset.searchUrl || "";
        const resultsBox = document.getElementById("customer-search-results");
        const customerIdInput = document.getElementById("customer-id");
        const selectionPill = document.getElementById("customer-selected-pill");
        const nameInput = document.querySelector('input[name="name"]');
        const phoneInput = document.querySelector('input[name="phone"]');
        const emailInput = document.querySelector('input[name="email"]');
        let debounceTimer = null;
        let lastQuery = "";
        let fillingFromSelection = false;

        function hideResults(){
          if (!resultsBox) return;
          resultsBox.innerHTML = "";
          resultsBox.hidden = true;
        }

        function showSelection(labelText){
          if (!selectionPill) return;
          selectionPill.textContent = labelText || "Cliente existente seleccionado";
          selectionPill.hidden = false;
        }

        function clearSelection(){
          if (customerIdInput) {
            customerIdInput.value = "";
          }
          if (selectionPill) {
            selectionPill.hidden = true;
          }
        }

        function renderEmpty(){
          if (!resultsBox) return;
          resultsBox.innerHTML = "";
          const empty = document.createElement("div");
          empty.className = "customer-search-result is-empty";
          empty.textContent = "Sin coincidencias, captura un cliente nuevo.";
          resultsBox.appendChild(empty);
          resultsBox.hidden = false;
        }

        function renderResults(items){
          if (!resultsBox) return;
          resultsBox.innerHTML = "";
          if (!items.length){
            renderEmpty();
            return;
          }
          const fragment = document.createDocumentFragment();
          items.forEach((item) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "customer-search-result";
            button.dataset.id = item.id;
            button.dataset.name = item.name || "";
            button.dataset.phone = item.phone || "";
            button.dataset.email = item.email || "";
            button.dataset.label = item.label || "";
            const title = document.createElement("strong");
            title.textContent = item.name || "Sin nombre";
            const meta = document.createElement("span");
            meta.textContent = [item.phone || "Sin telefono", item.email || "Sin correo"].filter(Boolean).join(" | ");
            button.appendChild(title);
            button.appendChild(meta);
            fragment.appendChild(button);
          });
          resultsBox.appendChild(fragment);
          resultsBox.hidden = false;
        }

        async function fetchResults(query){
          if (!searchUrl) return;
          try {
            const response = await fetch(`${searchUrl}?q=${encodeURIComponent(query)}`, {headers: {"X-Requested-With": "XMLHttpRequest"}});
            if (!response.ok) throw new Error("search failed");
            const payload = await response.json();
            if (query !== lastQuery) return;
            const items = Array.isArray(payload.results) ? payload.results : [];
            renderResults(items);
          } catch (error) {
            console.error("Error buscando clientes", error);
          }
        }

        function handleResultClick(event){
          const item = event.target.closest(".customer-search-result");
          if (!item || item.classList.contains("is-empty")) return;
          event.preventDefault();
          if (customerIdInput) {
            customerIdInput.value = item.dataset.id || "";
          }
          fillingFromSelection = true;
          if (nameInput) nameInput.value = item.dataset.name || "";
          if (phoneInput) phoneInput.value = item.dataset.phone || "";
          if (emailInput) emailInput.value = item.dataset.email || "";
          fillingFromSelection = false;
          const label = item.dataset.label || item.dataset.name || "Cliente existente seleccionado";
          showSelection(label);
          searchInput.value = label;
          hideResults();
        }

        if (resultsBox) {
          resultsBox.addEventListener("click", handleResultClick);
        }

        [nameInput, phoneInput, emailInput].forEach((input) => {
          if (!input) return;
          input.addEventListener("input", () => {
            if (fillingFromSelection) return;
            clearSelection();
          });
        });

        searchInput.addEventListener("input", (event) => {
          const value = event.target.value.trim();
          clearSelection();
          if (value.length < 2){
            lastQuery = "";
            hideResults();
            return;
          }
          lastQuery = value;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            fetchResults(value);
          }, 250);
        });

        document.addEventListener("click", (event) => {
          if (!resultsBox) return;
          if (event.target === searchInput || resultsBox.contains(event.target)) {
            return;
          }
          hideResults();
        });

        if (customerIdInput && customerIdInput.value) {
          showSelection(nameInput && nameInput.value ? `Cliente: ${nameInput.value}` : "Cliente existente seleccionado");
        }
      }

      const container = document.getElementById("device-formset");
      if (!container) return;
      const addButton = document.getElementById("add-device-btn");
      const totalInput = document.getElementById("id_{{ device_formset.prefix }}-TOTAL_FORMS");
      const maxInput = document.getElementById("id_{{ device_formset.prefix }}-MAX_NUM_FORMS");
      const maxForms = maxInput ? parseInt(maxInput.value || "{{ device_formset.max_num }}", 10) : {{ device_formset.max_num }};
      const template = document.getElementById("device-form-template");

      function getDeleteInput(formDiv){
        return formDiv.querySelector("input[name$='-DELETE']");
      }

      function getActiveForms(){
        return Array.from(container.querySelectorAll("[data-device-form]")).filter((formDiv) => {
          const deleteField = getDeleteInput(formDiv);
          return !formDiv.classList.contains("is-hidden") && !(deleteField && deleteField.checked);
        });
      }

      function updateRemoveButtons(){
        const activeCount = getActiveForms().length;
        container.querySelectorAll(".js-remove-device").forEach((btn) => {
          const formDiv = btn.closest("[data-device-form]");
          const deleteField = formDiv ? getDeleteInput(formDiv) : null;
          const isDeleted = deleteField && deleteField.checked;
          btn.style.display = activeCount <= 1 && !isDeleted ? "none" : "inline-flex";
        });
      }

      function handleRemove(event){
        const formDiv = event.currentTarget.closest("[data-device-form]");
        if (!formDiv) return;
        const deleteField = getDeleteInput(formDiv);
        if (!deleteField) return;
        if (getActiveForms().length <= 1){
          alert("La orden debe tener al menos un dispositivo.");
          return;
        }
        deleteField.checked = true;
        formDiv.classList.add("is-hidden");
        updateRemoveButtons();
      }

      function bindRemoveButtons(){
        container.querySelectorAll(".js-remove-device").forEach((btn) => {
          if (btn.dataset.bound === "1") return;
          btn.addEventListener("click", handleRemove);
          btn.dataset.bound = "1";
        });
        updateRemoveButtons();
      }

      function addDeviceForm(){
        if (!template || !totalInput) return;
        const currentTotal = parseInt(totalInput.value || "0", 10);
        if (currentTotal >= maxForms){
          alert("Alcanzaste el m&aacute;ximo de dispositivos permitidos.");
          return;
        }
        const html = template.innerHTML.replace(/__prefix__/g, currentTotal).replace(/__NUM__/g, currentTotal + 1);
        const wrapper = document.createElement("div");
        wrapper.innerHTML = html.trim();
        const newForm = wrapper.firstElementChild;
        container.appendChild(newForm);
        totalInput.value = currentTotal + 1;
        bindRemoveButtons();
      }

      if (addButton) {
        addButton.addEventListener("click", addDeviceForm);
      }
      bindRemoveButtons();
    });
  </script>
</body>
</html>
