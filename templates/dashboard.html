{% extends "base_nav.html" %}
{% load tz %}

{% block title %}Panel del staff{% endblock %}

{% block content %}
<div class="stack-lg">
  <div class="card section">
    <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3">
      <div>
        <h1 class="mb-1">Panel de servicio</h1>
        <p class="text-muted mb-0">Filtra y revisa la actividad reciente del taller.</p>
      </div>
      <form method="get" class="row g-3 align-items-end w-100 w-lg-auto">
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label" for="filter-q">Buscar</label>
          <input id="filter-q" type="text" name="q" class="form-control" placeholder="Folio, cliente, modelo" value="{{ q }}">
        </div>
        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label" for="filter-status">Estado</label>
          <select id="filter-status" name="status" class="form-select">
            <option value="">-- Estado --</option>
            {% for code, label in status_choices %}
              <option value="{{ code }}" {% if status == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label" for="filter-assignee">Técnico</label>
          <select id="filter-assignee" name="assignee" class="form-select">
            <option value="">-- Técnico --</option>
            {% for user in staff_users %}
              <option value="{{ user.id }}" {% if assignee == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label" for="filter-from">Desde</label>
          <input id="filter-from" type="date" name="from" value="{{ dfrom }}" class="form-control">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label" for="filter-to">Hasta</label>
          <input id="filter-to" type="date" name="to" value="{{ dto }}" class="form-control">
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Filtrar</button>
          <a class="btn btn-outline-secondary" href="{% url 'dashboard' %}">Limpiar</a>
        </div>
      </form>
    </div>
  </div>

  <div class="grid grid-2 section">
    <div class="card text-center">
      <div class="text-uppercase text-muted small">Total filtrado</div>
      <div class="fs-2 fw-semibold">{{ total_count }}</div>
    </div>
    <div class="card text-center">
      <div class="text-uppercase text-muted small">Hoy</div>
      <div class="fs-2 fw-semibold">{{ today_count }}</div>
    </div>
    <div class="card text-center">
      <div class="text-uppercase text-muted small">Últimos 7 días</div>
      <div class="fs-2 fw-semibold">{{ last7_count }}</div>
    </div>
    <div class="card text-center">
      <div class="text-uppercase text-muted small">Últimos 30 días</div>
      <div class="fs-2 fw-semibold">{{ last30_count }}</div>
    </div>
    <div class="card text-center">
      <div class="text-uppercase text-muted small">Promedio reparación</div>
      <div class="fs-2 fw-semibold">{{ avg_days|floatformat:2 }} días</div>
    </div>
  </div>

  <div class="grid grid-2 section">
    {% for item in status_cards %}
      <a class="card text-decoration-none h-100" href="/recepcion/ordenes/?status={{ item.code }}{{ status_preserve_query }}">
        <div class="text-uppercase text-muted small">{{ item.label }}</div>
        <div class="fs-5 fw-semibold">{{ item.count }}</div>
        <div class="text-muted small">Código {{ item.code }}</div>
      </a>
    {% endfor %}
  </div>

  <div class="card section">
    <h2 class="h5 mb-3">Órdenes por día</h2>
    {% if chart_points %}
      <svg class="w-100" style="max-height:220px" viewBox="0 0 {{ chart_width }} 100" preserveAspectRatio="none" role="img" aria-label="Evolución de ingresos diarios">
        <line x1="0" y1="100" x2="{{ chart_width }}" y2="100" stroke="#cbd5e0" stroke-width="1"></line>
        {% for point in chart_points %}
          <rect x="{{ point.x }}" y="{{ point.y }}" width="{{ point.width }}" height="{{ point.height }}" fill="#2563eb">
            <title>{{ point.label }}: {{ point.value }}</title>
          </rect>
        {% endfor %}
      </svg>
      <div class="d-flex flex-wrap gap-2 mt-3 text-muted small">
        {% for point in chart_points %}
          <span>{{ point.label }}</span>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">Sin datos para la gráfica.</p>
    {% endif %}
  </div>

  <div class="card section">
    <h2 class="h5 mb-3">Últimas 10 órdenes (filtradas)</h2>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>Folio</th>
            <th>Cliente</th>
            <th>Equipo</th>
            <th>Estado</th>
            <th>Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for o in recent_orders %}
            <tr>
              <td>{{ o.folio }}</td>
              <td>{{ o.device.customer.name }}</td>
              <td>{{ o.device.brand }} {{ o.device.model }}</td>
              <td>{{ o.get_status_display }}</td>
              <td>{{ o.checkin_at|localtime|date:"Y-m-d H:i" }}</td>
              <td class="d-flex gap-2">
                <a class="btn btn-outline-primary btn-sm" href="{% url 'order_detail' pk=o.pk %}">Interno</a>
                <a class="btn btn-outline-secondary btn-sm" href="{% url 'public_status' token=o.token %}" target="_blank" rel="noopener">Público</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-muted text-center">Sin órdenes recientes dentro del filtro.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
