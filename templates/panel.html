{% extends "base_nav.html" %}

{% block title %}Panel / KPIs{% endblock %}

{% block content %}
<div class="stack-lg">
  <div class="card section">
    <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3">
      <h1 class="mb-0">Panel / KPIs</h1>
      <form class="row g-3 align-items-end" method="get">
        <div class="col-auto">
          <label class="form-label" for="panel-from">De</label>
          <input type="date" name="from" id="panel-from" value="{{ from_date }}" class="form-control">
        </div>
        <div class="col-auto">
          <label class="form-label" for="panel-to">A</label>
          <input type="date" name="to" id="panel-to" value="{{ to_date }}" class="form-control">
        </div>
        <div class="col-auto d-flex gap-2 align-items-end">
          <button type="submit" class="btn btn-primary">Aplicar</button>
          <a class="btn btn-outline-secondary" href="?">Ultimos 30 d&iacute;as</a>
          <a class="btn btn-outline-secondary btn-sm" href="{% url "panel_export_csv" %}?from={{ from_date }}&amp;to={{ to_date }}">Exportar CSV</a>
        </div>
      </form>
    </div>
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <div class="text-uppercase text-muted small">Ordenes (rango)</div>
      <div class="fs-2 fw-semibold">{{ orders_total }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">Nuevas</div>
      <div class="fs-2 fw-semibold">{{ orders_new }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">En proceso</div>
      <div class="fs-2 fw-semibold">{{ orders_inprogress }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">Terminadas</div>
      <div class="fs-2 fw-semibold">{{ orders_done }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">Adjuntos subidos</div>
      <div class="fs-2 fw-semibold">{{ attachments_count }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">Pagos (suma)</div>
      <div class="fs-2 fw-semibold">${{ payments_total|floatformat:2 }}</div>
    </div>
    <div class="card">
      <div class="text-uppercase text-muted small">Ticket promedio</div>
      <div class="fs-2 fw-semibold">${{ avg_ticket|floatformat:2 }}</div>
    </div>
  </div>

  <div class="card section">
    <h2 class="h5 mb-3">Ultimas 10 &oacute;rdenes</h2>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Estatus</th>
            <th>Creada</th>
            <th>Total</th>
            <th>Saldo</th>
          </tr>
        </thead>
        <tbody>
          {% for it in last_items %}
          <tr>
            <td>#{{ it.id }}</td>
            <td>{{ it.customer }}</td>
            <td>{{ it.status }}</td>
            <td class="text-muted">{% if it.created_at %}{{ it.created_at|date:"Y-m-d H:i" }}{% else %}&mdash;{% endif %}</td>
            <td>{% if it.total is not None %}${{ it.total|floatformat:2 }}{% else %}&mdash;{% endif %}</td>
            <td>{% if it.balance is not None %}${{ it.balance|floatformat:2 }}{% else %}&mdash;{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-muted text-center">Sin &oacute;rdenes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card section">
    <p class="text-muted mb-0">{% if not is_mgr %}Acceso limitado pendiente de revisi&oacute;n.{% else %}Acceso de gerencia.{% endif %}</p>
  </div>
</div>
{% endblock %}
